// AI Model Manager - Encapsulated Module
const AIModelManager = (function() {
    // Private variables
    const API_KEYS = {
        dalle3: localStorage.getItem('dalle3_api_key') || '',
        stability: localStorage.getItem('stability_api_key') || '',
        turbo: localStorage.getItem('turbo_password') || ''
    };
    
    const MODEL_ENDPOINTS = {
        dalle3: 'https://api.openai.com/v1/images/generations',
        stability: 'https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image'
    };
    
    let currentModel = 'flux'; // Default to flux
    
    // DOM Elements
    const modelSelect = document.getElementById('model');
    const apiKeyModal = document.getElementById('api-key-modal');
    const apiKeyInput = document.getElementById('api-key-input');
    const apiKeyTitle = document.getElementById('api-key-modal-title');
    const apiKeyInstructions = document.getElementById('api-key-instructions');
    const apiKeyNote = document.getElementById('api-key-note');
    const validateApiKeyBtn = document.getElementById('validate-api-key-btn');
    const cancelApiKeyBtn = document.getElementById('cancel-api-key-btn');
    const closeApiKeyModal = document.getElementById('close-api-key-modal');
    const safeFilterCheckbox = document.getElementById('safe-filter');
    const resetBtn = document.getElementById('reset-btn');
    
    // Private methods
    function showApiKeyModal(model) {
        currentModel = model;
        
        // Clear any existing event listeners
        const oldShowPassword = document.getElementById('show-password');
        if (oldShowPassword) {
            oldShowPassword.replaceWith(oldShowPassword.cloneNode(true));
        }
        
        // Update modal content based on model
        if (model === 'dalle3') {
            apiKeyTitle.innerHTML = '<i class="fas fa-key"></i> OpenAI API Key Required';
            apiKeyInstructions.textContent = 'Please enter your OpenAI API key to use DALL-E 3.';
            apiKeyNote.innerHTML = 'Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI</a>.';
            apiKeyInput.value = API_KEYS.dalle3;
            apiKeyInput.placeholder = 'sk-...';
            apiKeyInput.type = 'password';
        } else if (model === 'stability') {
            apiKeyTitle.innerHTML = '<i class="fas fa-key"></i> Stability AI API Key Required';
            apiKeyInstructions.textContent = 'Please enter your Stability AI API key.';
            apiKeyNote.innerHTML = 'Get your API key from <a href="https://platform.stability.ai/account/keys" target="_blank">Stability AI</a>.';
            apiKeyInput.value = API_KEYS.stability;
            apiKeyInput.placeholder = 'sk-...';
            apiKeyInput.type = 'password';
        } else if (model === 'turbo') {
            apiKeyTitle.innerHTML = '<i class="fas fa-lock"></i> Turbo Model Password';
            apiKeyInstructions.textContent = 'Please enter the password to access Turbo model.';
            apiKeyNote.innerHTML = `
                <div style="margin-top: 10px;">
                    <input type="checkbox" id="show-password"> Show password
                </div>
                <div style="margin-top: 10px; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i> Warning: Any content generated by AI is your own responsibility.
                </div>
            `;
            apiKeyInput.value = API_KEYS.turbo;
            apiKeyInput.placeholder = 'Enter password...';
            apiKeyInput.type = 'password';
            
            // Add show/hide password toggle
            document.getElementById('show-password')?.addEventListener('change', function(e) {
                apiKeyInput.type = e.target.checked ? 'text' : 'password';
            });
        }
        
        apiKeyModal.style.display = 'flex';
        apiKeyInput.focus();
    }
    
    function hideApiKeyModal() {
        apiKeyModal.style.display = 'none';
    }
    
    function clearApiKeys() {
        // Clear from memory
        API_KEYS.dalle3 = '';
        API_KEYS.stability = '';
        API_KEYS.turbo = '';
        
        // Clear from localStorage
        localStorage.removeItem('dalle3_api_key');
        localStorage.removeItem('stability_api_key');
        localStorage.removeItem('turbo_password');
        
        // Reset model to default
        currentModel = 'flux';
        if (modelSelect) modelSelect.value = 'flux';
        if (safeFilterCheckbox) safeFilterCheckbox.checked = true;
    }
    
    async function validateApiKey() {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            Swal.fire({
                title: 'Error',
                text: 'Please enter a valid API key/password',
                icon: 'error',
                confirmButtonColor: 'var(--primary)',
                background: 'var(--bg)',
                color: 'var(--text)'
            });
            return;
        }
        
        validateApiKeyBtn.disabled = true;
        validateApiKeyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
        
        try {
            let isValid = false;
            
            if (currentModel === 'dalle3') {
                isValid = await validateOpenAIKey(apiKey);
            } else if (currentModel === 'stability') {
                isValid = await validateStabilityKey(apiKey);
            } else if (currentModel === 'turbo') {
                // For demo purposes, use a simple password check
                isValid = apiKey === 'ruangriungxyz';
                if (isValid) {
                    // Disable safe filter for turbo model
                    if (safeFilterCheckbox) safeFilterCheckbox.checked = false;
                }
            }
            
            if (isValid) {
                // Save the valid API key/password
                API_KEYS[currentModel] = apiKey;
                if (currentModel === 'turbo') {
                    localStorage.setItem('turbo_password', apiKey);
                } else if (currentModel === 'dalle3') {
                    localStorage.setItem('dalle3_api_key', apiKey);
                } else if (currentModel === 'stability') {
                    localStorage.setItem('stability_api_key', apiKey);
                }
                
                hideApiKeyModal();
                
                // Update the model select to the validated model
                if (modelSelect) modelSelect.value = currentModel;
                
                if (currentModel === 'turbo') {
                    Swal.fire({
                        title: 'Success',
                        html: 'Password validated! <span style="color: var(--danger)">NSFW filter has been disabled</span> for Turbo model.',
                        icon: 'success',
                        confirmButtonColor: 'var(--primary)',
                        background: 'var(--bg)',
                        color: 'var(--text)'
                    });
                } else {
                    Swal.fire({
                        title: 'Success',
                        text: 'API key validated successfully!',
                        icon: 'success',
                        confirmButtonColor: 'var(--primary)',
                        background: 'var(--bg)',
                        color: 'var(--text)'
                    });
                }
            } else {
                Swal.fire({
                    title: 'Error',
                    text: 'Invalid API key/password. Please check and try again.',
                    icon: 'error',
                    confirmButtonColor: 'var(--primary)',
                    background: 'var(--bg)',
                    color: 'var(--text)'
                });
                // Revert to flux
                if (modelSelect) modelSelect.value = 'flux';
                currentModel = 'flux';
            }
        } catch (error) {
            console.error('API key validation error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error validating API key. Please try again.',
                icon: 'error',
                confirmButtonColor: 'var(--primary)',
                background: 'var(--bg)',
                color: 'var(--text)'
            });
            // Revert to flux
            if (modelSelect) modelSelect.value = 'flux';
            currentModel = 'flux';
        } finally {
            validateApiKeyBtn.disabled = false;
            validateApiKeyBtn.textContent = 'Validate & Save';
        }
    }
    
    async function validateOpenAIKey(apiKey) {
        try {
            const response = await fetch('https://api.openai.com/v1/models', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                return Array.isArray(data.data);
            }
            return false;
        } catch (error) {
            console.error('OpenAI key validation error:', error);
            return false;
        }
    }
    
    async function validateStabilityKey(apiKey) {
        try {
            const response = await fetch('https://api.stability.ai/v1/user/account', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            });
            
            return response.ok;
        } catch (error) {
            console.error('Stability key validation error:', error);
            return false;
        }
    }
    
    function handleModelChange() {
        if (!modelSelect) return true;
        
        const selectedModel = modelSelect.value;
        
        if (selectedModel === 'dalle3' || selectedModel === 'stability' || selectedModel === 'turbo') {
            if (!API_KEYS[selectedModel]) {
                showApiKeyModal(selectedModel);
                return false; // Prevent model change until validated
            } else if (selectedModel === 'turbo') {
                // Disable safe filter for turbo model
                if (safeFilterCheckbox) safeFilterCheckbox.checked = false;
            }
        } else if (selectedModel === 'flux') {
            // Enable safe filter for flux model
            if (safeFilterCheckbox) safeFilterCheckbox.checked = true;
        }
        
        currentModel = selectedModel;
        return true;
    }
    
    function setupResetButton() {
        if (!resetBtn) return;
        
        resetBtn.addEventListener('click', function() {
            Swal.fire({
                title: 'Reset All Settings?',
                text: "This will clear all saved data including API keys and preferences. This cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--primary)',
                cancelButtonColor: 'var(--danger)',
                confirmButtonText: 'Yes, reset!',
                cancelButtonText: 'Cancel',
                background: 'var(--bg)',
                color: 'var(--text)'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Clear all stored data
                    clearApiKeys();
                    
                    // Show confirmation
                    Swal.fire({
                        title: 'Reset Complete!',
                        text: 'All settings have been reset to defaults.',
                        icon: 'success',
                        confirmButtonColor: 'var(--primary)',
                        background: 'var(--bg)',
                        color: 'var(--text)'
                    }).then(() => {
                        location.reload();
                    });
                }
            });
        });
    }
    
    // Public methods
    async function generateImage(prompt, settings) {
        if (!handleModelChange()) {
            return null; // API key not validated
        }
        
        try {
            switch(currentModel) {
                case 'dalle3':
                    return await generateWithDalle3(prompt, settings);
                case 'stability':
                    return await generateWithStability(prompt, settings);
                case 'turbo':
                    return generateWithPollinations(prompt, settings, 'turbo');
                case 'flux':
                default:
                    return generateWithPollinations(prompt, settings, 'flux');
            }
        } catch (error) {
            console.error('Image generation error:', error);
            Swal.fire({
                title: 'Generation Error',
                text: error.message || 'Failed to generate image',
                icon: 'error',
                confirmButtonColor: 'var(--primary)',
                background: 'var(--bg)',
                color: 'var(--text)'
            });
            throw error;
        }
    }
    
    async function generateWithDalle3(prompt, settings) {
        const response = await fetch(MODEL_ENDPOINTS.dalle3, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEYS.dalle3}`
            },
            body: JSON.stringify({
                prompt: prompt,
                model: "dall-e-3",
                size: `${settings.width}x${settings.height}`,
                quality: settings.quality === 'ultra' ? 'hd' : 'standard',
                n: 1
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Failed to generate image with DALL-E 3');
        }
        
        const data = await response.json();
        return data.data[0].url;
    }
    
    async function generateWithStability(prompt, settings) {
        const response = await fetch(MODEL_ENDPOINTS.stability, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEYS.stability}`,
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                text_prompts: [{ text: prompt }],
                cfg_scale: 7,
                height: parseInt(settings.height),
                width: parseInt(settings.width),
                samples: 1,
                steps: 30
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to generate image with Stability AI');
        }
        
        const data = await response.json();
        // Stability returns base64 image data
        return `data:image/png;base64,${data.artifacts[0].base64}`;
    }
    
    function generateWithPollinations(prompt, settings, modelType = 'flux') {
        const width = settings.width || 1024;
        const height = settings.height || 1024;
        const safeFilter = modelType === 'turbo' ? false : settings.safeFilter !== false;
        
        let ratioParam = `?width=${width}&height=${height}&nologo=true&safe=${safeFilter}&model=${modelType}`;
        
        if (settings.seed) {
            ratioParam += `&seed=${settings.seed}`;
        }
        
        const encodedPrompt = encodeURIComponent(prompt);
        return `https://image.pollinations.ai/prompt/${encodedPrompt}${ratioParam}`;
    }
    
    // Initialize
    function init() {
        // Update model select options in the DOM
        if (modelSelect) {
            const modelOptions = `
                <option value="flux">FLUX</option>
                <option value="turbo">Turbo</option>
                <option value="dalle3">DALL-E 3 (OpenAI)</option>
                <option value="stability">Stability AI</option>
            `;
            modelSelect.innerHTML = modelOptions;
            modelSelect.value = currentModel;
            
            modelSelect.addEventListener('change', function() {
                const selectedModel = this.value;
                
                if (selectedModel === 'turbo' || selectedModel === 'dalle3' || selectedModel === 'stability') {
                    if (!API_KEYS[selectedModel]) {
                        showApiKeyModal(selectedModel);
                        this.value = currentModel; // Revert selection until validated
                        return;
                    }
                    
                    if (selectedModel === 'turbo') {
                        if (safeFilterCheckbox) safeFilterCheckbox.checked = false;
                    }
                } else if (selectedModel === 'flux') {
                    if (safeFilterCheckbox) safeFilterCheckbox.checked = true;
                }
                
                currentModel = selectedModel;
            });
        }
        
        if (validateApiKeyBtn) {
            validateApiKeyBtn.addEventListener('click', validateApiKey);
        }
        
        if (cancelApiKeyBtn) {
            cancelApiKeyBtn.addEventListener('click', () => {
                if (modelSelect) modelSelect.value = 'flux';
                currentModel = 'flux';
                hideApiKeyModal();
            });
        }
        
        if (closeApiKeyModal) {
            closeApiKeyModal.addEventListener('click', () => {
                if (modelSelect) modelSelect.value = 'flux';
                currentModel = 'flux';
                hideApiKeyModal();
            });
        }
        
        if (apiKeyModal) {
            apiKeyModal.addEventListener('click', function(e) {
                if (e.target === apiKeyModal) {
                    if (modelSelect) modelSelect.value = 'flux';
                    currentModel = 'flux';
                    hideApiKeyModal();
                }
            });
        }
        
        // Setup reset button
        setupResetButton();
    }
    
    // Public API
    return {
        init: init,
        generateImage: generateImage,
        clearApiKeys: clearApiKeys
    };
})();

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    AIModelManager.init();
});